<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ•™å¸«ç¯€å¿«æ¨‚ â€” by91127 èƒ¡é–é‡</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --accent:#ff8a65; --muted:#6b6b6b;
    }
    *{box-sizing:border-box}
    body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
    header{padding:18px 20px; display:flex; align-items:center; gap:12px}
    h1{margin:0; font-size:20px}
    .container{display:grid; grid-template-columns:1fr 480px; gap:18px; padding:18px; max-width:1180px; margin:auto}
    .panel{background:rgba(255,255,255,0.9); padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    label{display:block; font-size:13px; margin-bottom:6px; color:var(--muted)}
    input[type=text], textarea, select{width:100%; padding:10px; border-radius:8px; border:1px solid #e4e7ef; font-size:14px}
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px}
    .btn{display:inline-block; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:#fff; font-weight:600}
    .muted{color:var(--muted); font-size:13px}
    /* preview card */
    .preview-wrap{position:relative}
    .card{width:100%; height:360px; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; padding:18px; background:linear-gradient(135deg,var(--card),#fff); box-shadow:0 8px 30px rgba(10,10,30,0.06)}
    .teacher-photo{width:96px; height:96px; border-radius:12px; object-fit:cover; border:4px solid rgba(255,255,255,0.6)}
    .card-top{display:flex; gap:14px; align-items:center}
    .card-body{flex:1; display:flex; align-items:center; justify-content:center; text-align:center}
    .card-body p{margin:0; padding:0 8px; font-size:20px}
    .card-footer{display:flex; justify-content:space-between; align-items:center}
    .small{font-size:12px; color:var(--muted)}
    /* signature on top-right */
    .signature{position:fixed; right:12px; top:12px; background:rgba(0,0,0,0.04); padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; backdrop-filter: blur(4px)}
    .signature:hover{transform:scale(1.02)}
    .signature button{background:none;border:none;margin-left:8px;cursor:pointer;color:#555}
    /* responsive */
    @media (max-width:980px){
      .container{grid-template-columns:1fr; padding:12px}
      .card{height:300px}
    }
  </style>
</head>
<body>
  <div class="signature" title="é»æ“Šå¯è¤‡è£½ç°½å">by91127 èƒ¡é–é‡ <button id="copySig" aria-label="è¤‡è£½ç°½å">ğŸ“‹</button></div>
  <header>
    <h1>æ•™å¸«ç¯€ç¥ç¦å°ç«™</h1>
    <div class="muted">å¿«é€Ÿè£½ä½œç¥ç¦å¡ã€äº’å‹•å‹•ç•«èˆ‡åŒ¯å‡ºåœ–ç‰‡</div>
  </header>

  <main class="container">
    <section class="panel" aria-labelledby="controls-title">
      <h2 id="controls-title">ç·¨è¼¯ç¥ç¦å¡</h2>

      <div style="margin-top:12px">
        <label>è€å¸«åç¨±</label>
        <input id="teacherName" type="text" placeholder="ä¾‹å¦‚ï¼šæ—è€å¸« / ç‹è€å¸«" value="æ•¬æ„›çš„è€å¸«" />
      </div>

      <div style="margin-top:12px">
        <label>ç¥ç¦æ–‡å­—</label>
        <textarea id="message">æ„Ÿè¬æ‚¨è€å¿ƒæ•™å°èˆ‡æ ½åŸ¹ï¼Œæ•™å¸«ç¯€å¿«æ¨‚ï¼</textarea>
      </div>

      <div style="margin-top:12px" class="row">
        <div style="flex:1">
          <label>ä¸»é¡Œ</label>
          <select id="themeSelect">
            <option value="#ff8a65">æº«æš–æ©˜</option>
            <option value="#4db6ac">æ¸…æ–°ç¶ </option>
            <option value="#90caf9">å¤©ç©ºè—</option>
            <option value="#ce93d8">æŸ”å’Œç´«</option>
          </select>
        </div>
        <div style="width:120px">
          <label>å­—é«”å¤§å°</label>
          <select id="fontSize">
            <option value="18">ä¸­</option>
            <option value="22" selected>å¤§</option>
            <option value="26">æ›´å¤§</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div style="flex:1">
          <label>è€å¸«ç…§ç‰‡ï¼ˆé¸å¡«ï¼Œæ”¯æ´æ‹–æ”¾ï¼‰</label>
          <input id="photoInput" type="file" accept="image/*" />
        </div>
        <div style="width:110px; display:flex; align-items:flex-end; gap:8px">
          <button class="btn" id="sendBtn">é€å‡ºç¥ç¦</button>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="savePng" class="btn">ä¸‹è¼‰ç‚ºåœ–ç‰‡</button>
        <button id="printBtn" class="btn">åˆ—å°</button>
        <button id="shareBtn" class="btn">åˆ†äº«ï¼ˆæ”¯æ´è£ç½®ï¼‰</button>
        <button id="resetBtn" class="btn" style="background:#6b6b6b">é‡è¨­</button>
      </div>

      <p class="muted" style="margin-top:10px">æç¤ºï¼šæŒ‰ã€Œé€å‡ºç¥ç¦ã€æœƒåœ¨é è¦½å‡ºç¾å½©å¸¶ç‰¹æ•ˆèˆ‡éŸ³æ•ˆã€‚è‹¥æƒ³æŠŠç¥ç¦å„²å­˜åœ¨ä¼ºæœå™¨æˆ–å¤šäººç•™è¨€ç‰†ï¼Œæˆ‘å¯ä»¥å¹«ä½ æ¥å¾Œç«¯ã€‚</p>
    </section>

    <aside class="panel preview-wrap">
      <h2>å³æ™‚é è¦½</h2>
      <div id="cardPreview" class="card" role="img" aria-label="ç¥ç¦å¡é è¦½" style="margin-top:12px; --accent:var(--accent)">
        <div class="card-top">
          <img id="photoPreview" class="teacher-photo" src="" alt="è€å¸«ç…§ç‰‡" style="display:none" />
          <div>
            <div class="small">æ•™å¸«ç¯€å¿«æ¨‚</div>
            <div id="namePreview" style="font-weight:800; font-size:16px; margin-top:6px">æ•¬æ„›çš„è€å¸«</div>
          </div>
        </div>

        <div class="card-body">
          <p id="messagePreview">æ„Ÿè¬æ‚¨è€å¿ƒæ•™å°èˆ‡æ ½åŸ¹ï¼Œæ•™å¸«ç¯€å¿«æ¨‚ï¼</p>
        </div>

        <div class="card-footer">
          <div class="small">ç”±å­¸ç”Ÿç»ä¸Š</div>
          <div class="small">â€” æ•™å­¸æœ‰æ‚¨ï¼Œæº«æš–ä¸€è·¯</div>
        </div>
      </div>

      <!-- canvas for confetti (canvas-confetti uses its own) -->
      <canvas id="confetti-canvas" style="position:absolute; inset:0; pointer-events:none"></canvas>
    </aside>
  

    <section class="panel" id="message-wall" aria-labelledby="msg-wall-title" style="grid-column:1/-1">
      <h2 id="msg-wall-title">ç•™è¨€ç‰†</h2>

      <div style="margin-top:12px">
        <label>ç¨±å‘¼ï¼ˆé¸å¡«ï¼‰</label>
        <input id="msgName" type="text" placeholder="ä¾‹å¦‚ï¼šå°æ˜ / åŒ¿åå­¸ç”Ÿ" />
      </div>

      <div style="margin-top:12px">
        <label>ç•™è¨€å…§å®¹</label>
        <textarea id="msgText" placeholder="å¯«ä¸‹ä½ å°è€å¸«çš„è©±â€¦"></textarea>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
        <button id="sendMsgBtn" class="btn">ç™¼ä½ˆç•™è¨€</button>
        <button id="signOutBtn" class="btn" style="background:#6b6b6b">ç™»å‡º</button>
        <div class="muted" style="margin-left:auto">ç•™è¨€å°‡æœƒå³æ™‚å‡ºç¾åœ¨ä¸‹æ–¹</div>
      </div>

      <div style="margin-top:16px">
        <h3>ç•™è¨€åˆ—è¡¨</h3>
        <div id="messagesList" style="max-height:360px; overflow:auto; padding:8px; border-radius:8px; background:rgba(0,0,0,0.02)"></div>
      </div>
    </section>

  </main>

  <!-- Firebase ç•™è¨€ç‰†æ¨¡çµ„åŒ–è…³æœ¬ -->
  <script type="module">
    // Firebase Web SDK (modular) â€” ç•™è¨€ç‰†æ•´åˆ
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

    // ==== è«‹æŠŠä¸‹é¢çš„ firebaseConfig æ›æˆä½ è‡ªå·±çš„è¨­å®šï¼ˆå¾ Firebase Console -> Project settings -> Your apps å–å¾—ï¼‰ ====
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      // ...å…¶ä»–æ¬„ä½
    };

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM refs
    const messagesList = document.getElementById('messagesList');
    const sendBtn = document.getElementById('sendMsgBtn');
    const nameInput = document.getElementById('msgName');
    const textInput = document.getElementById('msgText');
    const signOutBtn = document.getElementById('signOutBtn');

    let currentUser = null;
    let isAdmin = false;

    // åŒ¿åç™»å…¥ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰
    signInAnonymously(auth).catch(err => console.warn('åŒ¿åç™»å…¥å¤±æ•—', err));

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        try {
          const tokenRes = await getIdTokenResult(user, false);
          isAdmin = !!(tokenRes?.claims?.admin);
        } catch (e) {
          isAdmin = false;
        }
        signOutBtn.style.display = 'inline-block';
      } else {
        isAdmin = false;
        signOutBtn.style.display = 'none';
      }
      // é‡æ–° render åˆ—è¡¨æŒ‰éˆ•å¯è¦‹æ€§
      // (onSnapshot å…§æœƒé‡æ–°ç”ŸæˆæŒ‰éˆ•ï¼Œä½¿ç”¨æœ€æ–°çš„ isAdmin & currentUser)
    });

    signOutBtn.addEventListener('click', async ()=>{
      try{ await signOut(auth); alert('å·²ç™»å‡º'); }
      catch(e){ console.warn('ç™»å‡ºå¤±æ•—', e); }
    });

    async function sendMessage(){
      if (!currentUser) return alert('è«‹å…ˆç™»å…¥ï¼ˆæˆ–å…è¨±åŒ¿åç™»å…¥ï¼‰');
      const name = (nameInput.value || 'åŒ¿åå­¸ç”Ÿ').slice(0,60);
      const text = (textInput.value || '').trim();
      if (!text) return alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
      sendBtn.disabled = true;
      try{
        await addDoc(collection(db, 'messages'), {
          name, text, uid: currentUser.uid, createdAt: serverTimestamp()
        });
        textInput.value = '';
      }catch(e){ console.error('æ–°å¢ç•™è¨€å¤±æ•—', e); alert('æ–°å¢ç•™è¨€å¤±æ•—ï¼š'+e.message); }
      sendBtn.disabled = false;
    }

    sendBtn.addEventListener('click', sendMessage);

    // å–å¾—ä¸¦å³æ™‚ç›£è½ messages
    const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      messagesList.innerHTML = '';
      if (snapshot.empty) {
        messagesList.innerHTML = '<div class="muted">ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€å€‹å§ï¼</div>';
        return;
      }
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;

        const row = document.createElement('div');
        row.style.padding = '10px'; row.style.borderBottom = '1px solid rgba(0,0,0,0.04)'; row.style.display='flex'; row.style.alignItems='flex-start';

        const left = document.createElement('div');
        left.style.flex='1';
        const nameEl = document.createElement('div'); nameEl.textContent = d.name || 'åŒ¿å'; nameEl.style.fontWeight='700';
        const textEl = document.createElement('div'); textEl.textContent = d.text || ''; textEl.style.margin='6px 0';
        const metaEl = document.createElement('div'); metaEl.className='muted'; metaEl.style.fontSize='12px';
        metaEl.textContent = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : '';

        left.appendChild(nameEl); left.appendChild(textEl); left.appendChild(metaEl);
        row.appendChild(left);

        // actionsï¼ˆåˆªé™¤ï¼‰
        const actions = document.createElement('div'); actions.style.marginLeft='12px';
        if (currentUser && (d.uid === currentUser.uid || isAdmin)){
          const del = document.createElement('button'); del.textContent='åˆªé™¤'; del.className='btn'; del.style.background='#e57373'; del.addEventListener('click', async ()=>{
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ')) return;
            try{ await deleteDoc(doc(db, 'messages', id)); }catch(e){ console.error('åˆªé™¤å¤±æ•—', e); alert('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
          });
          actions.appendChild(del);
        }
        row.appendChild(actions);
        messagesList.appendChild(row);
      });
    }, (err)=>{ console.error('ç›£è½ç•™è¨€å¤±æ•—', err); messagesList.innerHTML = '<div class="muted">è¼‰å…¥ç•™è¨€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console</div>'; });

    // Debug
    window._fs = { db, auth };
  </script>

</body>

  <!-- Libraries from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // Helper: DOM refs
    const teacherName = document.getElementById('teacherName');
    const message = document.getElementById('message');
    const theme = document.getElementById('themeSelect');
    const fontSize = document.getElementById('fontSize');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const namePreview = document.getElementById('namePreview');
    const messagePreview = document.getElementById('messagePreview');
    const cardPreview = document.getElementById('cardPreview');
    const sendBtn = document.getElementById('sendBtn');
    const savePng = document.getElementById('savePng');
    const printBtn = document.getElementById('printBtn');
    const shareBtn = document.getElementById('shareBtn');
    const resetBtn = document.getElementById('resetBtn');
    const confettiCanvas = document.getElementById('confetti-canvas');

    // initialize theme color
    function applyThemeColor(c){
      document.documentElement.style.setProperty('--accent', c);
      // small gradient change to card background using the chosen color
      cardPreview.style.background = `linear-gradient(135deg, ${c}15, #fff)`;
      // adjust property accessible in CSS variable if needed
    }
    applyThemeColor(theme.value);

    // live update functions
    teacherName.addEventListener('input', ()=> namePreview.textContent = teacherName.value || 'æ•¬æ„›çš„è€å¸«');
    message.addEventListener('input', ()=> messagePreview.textContent = message.value || 'æ„Ÿè¬æ‚¨è€å¿ƒæ•™å°èˆ‡æ ½åŸ¹ï¼Œæ•™å¸«ç¯€å¿«æ¨‚ï¼');
    theme.addEventListener('change', ()=> applyThemeColor(theme.value));
    fontSize.addEventListener('change', ()=> messagePreview.style.fontSize = fontSize.value + 'px');

    // photo handling (file -> dataURL)
    photoInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      photoPreview.src = url;
      photoPreview.style.display = 'block';
    });

    // drag & drop support onto the preview
    cardPreview.addEventListener('dragover', (e)=>{ e.preventDefault(); cardPreview.style.opacity = 0.9 });
    cardPreview.addEventListener('dragleave', (e)=>{ cardPreview.style.opacity = 1 });
    cardPreview.addEventListener('drop', (e)=>{
      e.preventDefault(); cardPreview.style.opacity = 1;
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if(file && file.type.startsWith('image/')){
        photoInput.files = e.dataTransfer.files;
        const url = URL.createObjectURL(file);
        photoPreview.src = url; photoPreview.style.display = 'block';
      }
    });

    // copy signature
    document.getElementById('copySig').addEventListener('click', ()=>{
      navigator.clipboard?.writeText('by91127 èƒ¡é–é‡').then(()=>{
        alert('ç°½åå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
      }).catch(()=>alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½'));
    });

    // simple chime with WebAudio (no external audio files)
    function chime(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // resume if autoplay policy suspended the context
        if (ctx.state === 'suspended' && typeof ctx.resume === 'function') {
          ctx.resume().catch(()=>{});
        }
        const now = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(880, now);
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.12, now + 0.01);
        o.connect(g); g.connect(ctx.destination);
        o.start(now);
        o.frequency.exponentialRampToValueAtTime(660, now + 0.25);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
        o.stop(now + 0.7);
      }catch(e){ console.warn('Audio not supported', e)}
    }

    // confetti using canvas-confetti (fixed reference and safe guards)
    const confettiLib = window.confetti || null;
    function burstConfetti(){
      if(!confettiLib){ console.warn('confetti lib not loaded'); return; }
      try{
        const myConfetti = confettiLib.create(confettiCanvas, {resize:true, useWorker:true});
        myConfetti({particleCount:60, spread:120, startVelocity:50});
        setTimeout(()=> myConfetti({particleCount:40, spread:80, origin:{x:0.2, y:0.2}}), 250);
      }catch(e){ console.warn('confetti error', e) }
    }

    // send button behavior
    sendBtn.addEventListener('click', ()=>{
      // visual pulse on card
      cardPreview.animate([{transform:'scale(1)'},{transform:'scale(1.02)'}],{duration:240, easing:'ease-out'});
      // confetti + chime
      burstConfetti(); chime();
      // small temporary overlay text
      const overlay = document.createElement('div');
      overlay.textContent = 'ç¥ç¦å·²é€å‡º ğŸ‰';
      overlay.style.position='absolute'; overlay.style.left='50%'; overlay.style.top='20%'; overlay.style.transform='translate(-50%,-50%)';
      overlay.style.padding='10px 14px'; overlay.style.borderRadius='12px'; overlay.style.background='rgba(255,255,255,0.9)'; overlay.style.fontWeight='700';
      cardPreview.appendChild(overlay);
      setTimeout(()=> overlay.remove(), 1600);
    });

    // save as PNG using html2canvas
    savePng.addEventListener('click', async ()=>{
      savePng.disabled = true; savePng.textContent = 'è™•ç†ä¸­...';
      try{
        const canvas = await html2canvas(cardPreview, {backgroundColor:null, scale:2});
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `${(teacherName.value||'teacher')}_teacherday.png`;
        a.click();
      }catch(e){ alert('åŒ¯å‡ºå¤±æ•—ï¼š'+e.message) }
      savePng.disabled=false; savePng.textContent='ä¸‹è¼‰ç‚ºåœ–ç‰‡';
    });

    // print (open in new window)
    printBtn.addEventListener('click', async ()=>{
      const canvas = await html2canvas(cardPreview, {backgroundColor:'#fff', scale:2});
      const data = canvas.toDataURL();
      const w = window.open('','_blank');
      w.document.write(`<img src="${data}" style="max-width:100%;height:auto;display:block;margin:0 auto"/>`);
      w.document.title = 'åˆ—å°ç¥ç¦å¡ - æ•™å¸«ç¯€';
      setTimeout(()=> w.print(), 500);
    });

    // share via Web Share API if available
    shareBtn.addEventListener('click', async ()=>{
      if(navigator.share){
        try{
          const canvas = await html2canvas(cardPreview, {backgroundColor:null, scale:2});
          canvas.toBlob(async (blob)=>{
            const filesArray = [new File([blob], 'teacherday.png', {type:'image/png'})];
            await navigator.share({ files: filesArray, title: 'æ•™å¸«ç¯€ç¥ç¦', text: `${teacherName.value || 'æ•¬æ„›çš„è€å¸«'}ï¼Œæ”¶åˆ°ä¸€å¼µç¥ç¦å¡` });
          });
        }catch(e){ alert('åˆ†äº«å¤±æ•—ï¼š'+e.message) }
      }else{
        alert('æ‚¨çš„è£ç½®æˆ–ç€è¦½å™¨ä¸æ”¯æ´åˆ†äº«åŠŸèƒ½ï¼Œå¯å…ˆä¸‹è¼‰åœ–ç‰‡å†æ‰‹å‹•åˆ†äº«ã€‚');
      }
    });

    // reset
    resetBtn.addEventListener('click', ()=>{
      teacherName.value = 'æ•¬æ„›çš„è€å¸«'; message.value='æ„Ÿè¬æ‚¨è€å¿ƒæ•™å°èˆ‡æ ½åŸ¹ï¼Œæ•™å¸«ç¯€å¿«æ¨‚ï¼'; theme.value='#ff8a65'; fontSize.value='22'; photoInput.value=''; photoPreview.style.display='none'; namePreview.textContent = teacherName.value; messagePreview.textContent = message.value; applyThemeColor(theme.value);
    });

    // small accessibility: update preview with initial values
    namePreview.textContent = teacherName.value;
    messagePreview.textContent = message.value;
    messagePreview.style.fontSize = fontSize.value + 'px';

    // keyboard shortcut: Ctrl/Cmd+S to save image
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){
        e.preventDefault(); savePng.click();
      }
    });

  </script>
</body>
</html>
